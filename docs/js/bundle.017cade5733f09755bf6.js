(()=>{"use strict";var e={config:{teamName:"Anonymous",savedFolder:null},categories:[],tags:[],suggestions:[],history:[],docs:[]},t={currentView:"pending",currentCatFilter:"all",editingId:null,selectedCatId:null,confirmCallback:null,codeInsertMode:null,tagEmojiSelected:"üè∑Ô∏è",newCatEmojiSelected:"üóÇÔ∏è",attachType:null,pendingAttachments:[],fileHandle:null,dirHandle:null},a={pat:"",repo:"",branch:"main",path:"",lastPushAt:null,lastPushSha:null,lastPullAt:null};function n(){localStorage.setItem("accord-sg-data",JSON.stringify(e)),t.fileHandle&&i()}async function i(){try{var a=await t.fileHandle.createWritable();await a.write(JSON.stringify(e,null,2)),await a.close()}catch(e){console.warn("File write failed:",e)}}function o(t){if(!t)return null;if(t.startsWith("doc:")){var a=t.slice(4),n=(e.docs||[]).find(function(e){return e.id===a});return n?{id:t,name:n.title.replace(/^\d+\.\s+/,""),emoji:"üìÑ",isDocSection:!0}:null}return e.categories.find(function(e){return e.id===t})||null}function s(t){return e.suggestions.find(function(e){return e.id===t})||null}function c(e){if(!e)return"";try{return new Date(e).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}catch(t){return e}}function r(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function d(e){var t=document.getElementById(e);t&&t.classList.add("show")}function l(e){var t=document.getElementById(e);t&&t.classList.remove("show")}var m=null;function u(e,t){var a=document.getElementById("toast");a&&(a.innerHTML="<span>"+({success:'<i class="fa-solid fa-check"></i>',error:'<i class="fa-solid fa-xmark"></i>',info:'<i class="fa-solid fa-circle-info"></i>'}[t]||"¬∑")+"</span> "+r(e),a.className="notif-toast "+(t||"info")+" show",m&&clearTimeout(m),m=setTimeout(function(){a.classList.remove("show")},2800))}var g=["üóÇÔ∏è","üåê","üîí","‚ö°","üõ°Ô∏è","üîß","üì°","üéØ","üîó","üí°","üöÄ","üîë","üåç","üèóÔ∏è","üìä","üé®","üî¨","üíª","ü§ù","üìã","ü¶æ","üß¨","‚öôÔ∏è","üéõÔ∏è","üå±","üîÆ","üèÜ","üé™","üåä","üî•","üí´","üé≠","üõ∏","üåô","‚≠ê","üé≤","ü¶ã","üê∏","üê±","WOLF","ü¶Ö","FOX","üêâ","üß†","üëæ","üéµ","üé∏","üéØ","üè¥","üö©","‚ú®","üíé","üî¥","üü¢","üü°","üîµ","üü£"];function f(t,a,n,i,o){e.history.push({id:"hist_"+Date.now()+"_"+Math.random().toString(36).slice(2,6),action:t,suggestionId:a,title:n,by:i,at:(new Date).toISOString(),note:o||""}),L()}function p(e){var t=document.getElementById("info-boxes-grid");if(t){for(var a=e||[{label:"IMPLEMENTATION",value:""},{label:"AFFECTS",value:""},{label:"BENEFIT",value:""}];a.length<3;)a.push({label:"",value:""});t.innerHTML=a.slice(0,3).map(function(e,t){return'<div class="info-box-item"><input class="info-box-title-field" id="ib-label-'+t+'" type="text" placeholder="LABEL" value="'+r(e.label||"")+'"><textarea class="info-box-val-field" id="ib-val-'+t+'" placeholder="Content‚Ä¶">'+r(e.value||"")+"</textarea></div>"}).join("")}}function v(e){if(e&&e.length){Array.from(e).forEach(function(e){var a=e.type.startsWith("image/")?"image":e.type.startsWith("video/")?"video":null;if(a){var n=new FileReader;n.onload=function(n){t.pendingAttachments.push({type:a,name:e.name,data:n.target.result}),h(),u(e.name+" attached!","success")},n.readAsDataURL(e)}else u("Unsupported file type: "+e.name,"error")});var a=document.getElementById("attach-drop-input");a&&(a.value="")}}function h(){var e=document.getElementById("attachment-list");e&&(t.pendingAttachments.length?e.innerHTML=t.pendingAttachments.map(function(e,t){return'<div class="attachment-chip">'+({image:'<i class="fa-solid fa-image"></i>',video:'<i class="fa-solid fa-film"></i>',html:'<i class="fa-solid fa-code"></i>',mermaid:'<i class="fa-solid fa-diagram-project"></i>'}[e.type]||'<i class="fa-solid fa-paperclip"></i>')+" "+r(e.name)+'<button onclick="removeAttachment('+t+')" title="Remove"><i class="fa-solid fa-xmark"></i></button></div>'}).join(""):e.innerHTML='<span style="font-size:12px;color:var(--text-muted)">No attachments yet.</span>')}function y(){var a=t.currentView;if("history"!==a){var n=document.getElementById("cards-"+a);if(n){var i=(document.getElementById("search-"+a)||{}).value||"";i=i.toLowerCase();var s=e.suggestions.filter(function(e){return e.status===a&&(("all"===t.currentCatFilter||e.categoryId===t.currentCatFilter)&&(!i||-1!==(e.title+" "+e.body+" "+(e.tag?e.tag.name:"")).toLowerCase().indexOf(i)))}),d={};if(s.forEach(function(e){var t=o(e.categoryId),a=e.categoryId||"uncategorized";d[a]||(d[a]={cat:t,items:[]}),d[a].items.push(e)}),0!==s.length){var l="";Object.values(d).forEach(function(a){if("all"===t.currentCatFilter&&Object.keys(d).length>1){var n=a.cat?a.cat.emoji+" "+a.cat.name:"üóÇÔ∏è Uncategorized";l+='<div class="section-divider">'+r(n)+"<span>"+a.items.length+" suggestion"+(1!==a.items.length?"s":"")+"</span></div>"}a.items.forEach(function(t){l+=function(t){var a=o(t.categoryId),n=t.tag||{name:"UNTAGGED",emoji:""},i="badge-"+t.status,s=t.status.charAt(0).toUpperCase()+t.status.slice(1),d="Suggested by",l="",m=t.suggestedBy||e.config.teamName;"approved"===t.status?(d="Approved by",l="approved",m=t.approvedBy||m):"rejected"===t.status?(d="Rejected by",l="rejected",m=t.rejectedBy||m):"archived"===t.status&&(d="Archived by",l="archived",m=t.archivedBy||m);var u="";t.infoBoxes&&t.infoBoxes.some(function(e){return e.label||e.value})&&(u='<div class="impact-grid">',t.infoBoxes.forEach(function(e){(e.label||e.value)&&(u+='<div class="impact-item"><div class="impact-label">'+r(e.label)+'</div><div class="impact-value">'+r(e.value)+"</div></div>")}),u+="</div>");var g="";t.attachments&&t.attachments.length&&(g='<div class="card-attachments">',t.attachments.forEach(function(e,a){if("image"===e.type)g+='<div class="card-attachment"><img src="'+e.data+'" alt="attachment"><div class="card-attachment-label"><i class="fa-solid fa-image"></i> '+r(e.name||"image")+"</div></div>";else if("video"===e.type)g+='<div class="card-attachment"><video src="'+e.data+'" controls></video><div class="card-attachment-label"><i class="fa-solid fa-film"></i> '+r(e.name||"video")+"</div></div>";else if("html"===e.type){var n=new Blob([e.data],{type:"text/html"}),i=URL.createObjectURL(n),o=e.fullwidth?" fullwidth":"";g+='<div class="card-attachment'+o+'"><iframe src="'+i+'" sandbox="allow-scripts allow-same-origin"></iframe><div class="card-attachment-label"><i class="fa-solid fa-code"></i> '+r(e.name||"HTML Block")+"</div></div>"}else"mermaid"===e.type&&(g+='<div class="mermaid-wrap"><div class="mermaid-label"><i class="fa-solid fa-diagram-project"></i> Mermaid Diagram</div><div class="mermaid" id="mermaid-'+t.id+"-"+a+'">'+r(e.data)+"</div></div>")}),g+="</div>");var f='<div class="card-actions">';return"pending"===t.status?(f+="<button class=\"card-action-btn approve-btn\" onclick=\"confirmAction('approve','"+t.id+'\')"><i class="fa-solid fa-check"></i> Approve</button>',f+="<button class=\"card-action-btn reject-btn\" onclick=\"confirmAction('reject','"+t.id+'\')"><i class="fa-solid fa-xmark"></i> Reject</button>',f+='<button class="card-action-btn edit-btn" onclick="openEditor(\''+t.id+'\')"><i class="fa-solid fa-pen"></i> Edit</button>'):"approved"===t.status?(f+="<button class=\"card-action-btn reject-btn\" onclick=\"confirmAction('revoke','"+t.id+'\')"><i class="fa-solid fa-xmark"></i> Remove from Docs</button>',f+='<button class="card-action-btn edit-btn" onclick="openEditor(\''+t.id+'\')"><i class="fa-solid fa-pen"></i> Edit</button>'):"rejected"===t.status?(f+="<button class=\"card-action-btn approve-btn\" onclick=\"confirmAction('approve','"+t.id+'\')"><i class="fa-solid fa-check"></i> Approve</button>',f+="<button class=\"card-action-btn archive-btn\" onclick=\"confirmAction('archive','"+t.id+'\')"><i class="fa-solid fa-box-archive"></i> Archive</button>'):"archived"===t.status&&(f+="<button class=\"card-action-btn\" onclick=\"confirmAction('restore','"+t.id+'\')"><i class="fa-solid fa-rotate-left"></i> Restore to Pending</button>'),f+="</div>",'<div class="suggestion-card status-'+t.status+'" id="card-'+t.id+'"><div class="card-top"><div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;"><div class="card-tag">'+(n.emoji?r(n.emoji)+" ":"")+r(n.name)+"</div>"+(a?'<span class="card-category-pill">'+r(a.emoji||"")+" "+r(a.name)+"</span>":"")+'</div><span class="card-status-badge '+i+'">'+s+'</span></div><div class="card-title">'+r(t.title)+'</div><div class="card-body">'+w(t.body||"")+"</div>"+u+g+'<div class="card-meta" style="margin-top:14px;"><div class="card-author-tag '+l+'"><span class="author-dot"></span>'+r(d)+": "+r(m)+"</div><span style=\"margin-left:auto;font-size:10.5px;font-family:'JetBrains Mono',monospace;color:var(--text-muted);\">"+c(t.createdAt)+"</span></div>"+f+"</div>"}(t)})}),n.innerHTML=l,b(n)}else n.innerHTML='<div class="empty-state"><div class="empty-icon"><i class="fa-solid fa-lightbulb"></i></div><h3>No '+a+" suggestions</h3><p>Nothing to show here yet.</p></div>"}}else B()}function b(e){var t=e.querySelectorAll(".mermaid");t.length&&mermaid.run({nodes:Array.from(t)})}function w(e){if(!e)return"";for(var t=0,a="";t<e.length;){if("("===e[t]&&t+1<e.length){var n=E(e,t);if(-1!==n){var i=I(e.slice(t+1,n));if(null!==i){a+=i,t=n+1;continue}}}if("*"===e[t]&&"*"===e[t+1]){var o=e.indexOf("**",t+2);if(-1!==o){a+='<span class="sug-bold">'+r(e.slice(t+2,o))+"</span>",t=o+2;continue}}if("`"===e[t]){var s=e.indexOf("`",t+1);if(-1!==s){a+='<code class="sug-code">'+r(e.slice(t+1,s))+"</code>",t=s+1;continue}}"\n"!==e[t]?(a+=r(e[t]),t++):(a+="<br>",t++)}return a}function E(e,t){for(var a=0,n=t;n<e.length;n++)if("("===e[n])a++;else if(")"===e[n]&&0===--a)return n;return-1}function I(e){if(e.startsWith("[")&&e.endsWith("]"))return'<span class="sug-keyword">'+r(e.slice(1,-1))+"</span>";var t=e.match(/^(.*?)\s*\[([^\]]+)\]\s*$/);if(t){var a=t[1].trim(),n=t[2].trim();return n.match(/^https?:\/\//)||(n="https://"+n),'<a href="'+r(n)+'" class="sug-link" target="_blank" rel="noopener">'+r(a)+"</a>"}var i=e.match(/^(.*?)\s*<([^>]+)>\s*$/);if(i){var o=i[1].trim(),s=i[2].trim();return'<span class="sug-tooltip-wrap">'+r(o)+'<span class="sug-tooltip-popup">'+r(s)+"</span></span>"}return null}function B(){var t=document.getElementById("history-list"),a=(document.getElementById("search-history")||{}).value||"";a=a.toLowerCase();var n=e.history.slice().reverse();if(a&&(n=n.filter(function(e){return-1!==(e.action+e.by+e.title+e.note).toLowerCase().indexOf(a)})),n.length){var i={created:'<i class="fa-solid fa-lightbulb"></i>',approved:'<i class="fa-solid fa-circle-check"></i>',rejected:'<i class="fa-solid fa-circle-xmark"></i>',archived:'<i class="fa-solid fa-box-archive"></i>',edited:'<i class="fa-solid fa-pen"></i>',restored:'<i class="fa-solid fa-rotate-left"></i>',revoked:'<i class="fa-solid fa-ban"></i>'},o={created:"hist-created",approved:"hist-approved",rejected:"hist-rejected",archived:"hist-archived",edited:"hist-edited",restored:"hist-created",revoked:"hist-rejected"},s=n.map(function(e){return'<div class="history-entry"><div class="history-icon '+(o[e.action]||"hist-edited")+'">'+(i[e.action]||"¬∑")+'</div><div class="history-content"><div class="history-action"><strong>'+r(e.by)+"</strong> "+r({created:"created suggestion",approved:"approved",rejected:"rejected",archived:"archived",edited:"edited",restored:"restored",revoked:"removed from docs"}[t=e.action]||t)+' <strong>"'+r(e.title)+'"</strong>'+(e.note?" ‚Äî <em>"+r(e.note)+"</em>":"")+'</div><div class="history-meta"><span>'+r(e.action)+"</span><span>"+c(e.at)+"</span></div></div></div>";var t}).join("");t.innerHTML=s}else t.innerHTML='<div class="empty-state"><div class="empty-icon"><i class="fa-solid fa-clipboard-list"></i></div><h3>No history yet</h3><p>Actions on suggestions will appear here.</p></div>'}function j(a){var n=document.getElementById("cat-options-list");if(n){var i=a?a.toLowerCase():"",o=e.categories.filter(function(e){return!i||-1!==e.name.toLowerCase().indexOf(i)}),s=(e.docs||[]).filter(function(e){return 2===e.level&&(!i||-1!==e.title.toLowerCase().indexOf(i))});if(o.length||s.length){var c="";o.length&&(c+='<div class="cat-group-label">Suggestion Categories</div>',c+=o.map(function(a){var n=e.suggestions.filter(function(e){return e.categoryId===a.id}).length;return'<div class="cat-option'+(t.selectedCatId===a.id?" selected":"")+'" onclick="selectCat(\''+a.id+'\', this)"><span class="cat-emoji-badge">'+r(a.emoji||"üóÇÔ∏è")+'</span><span class="cat-name">'+r(a.name)+'</span><span class="cat-sub">'+n+" suggestion"+(1!==n?"s":"")+"</span></div>"}).join("")),s.length&&(c+='<div class="cat-group-label"><i class="fa-solid fa-book" style="margin-right:5px;"></i>Documentation Sections</div>',c+=s.map(function(a){var n="doc:"+a.id,i=e.suggestions.filter(function(e){return e.categoryId===n}).length,o=a.title.replace(/^\d+\.\s+/,"");return'<div class="cat-option doc-cat'+(t.selectedCatId===n?" selected":"")+'" onclick="selectCat(\''+n+'\', this)"><span class="cat-emoji-badge"><i class="fa-solid fa-file-lines" style="font-size:14px;color:var(--accent);"></i></span><span class="cat-name">'+r(o)+'</span><span class="cat-sub">'+i+" suggestion"+(1!==i?"s":"")+"</span></div>"}).join("")),n.innerHTML=c}else n.innerHTML='<div style="padding:16px;text-align:center;font-size:12px;color:var(--text-muted)">No categories found. Click + to create one.</div>'}}function C(){var a=document.getElementById("cat-nav-list");if(a){var n=e.suggestions.filter(function(e){return e.status===t.currentView}).length,i=document.getElementById("cat-count-all");i&&(i.textContent=n);var s="",c=e.categories.filter(function(t){return e.suggestions.some(function(e){return e.categoryId===t.id})});c.length&&c.forEach(function(a){var n=e.suggestions.filter(function(e){return e.categoryId===a.id&&e.status===t.currentView}).length;s+='<button class="cat-nav-item'+(t.currentCatFilter===a.id?" active":"")+'" onclick="filterCategory(\''+a.id+'\', this)" data-cat="'+a.id+'"><span class="cat-emoji" style="font-size:13px;">'+r(a.emoji||"üóÇÔ∏è")+"</span><span>"+r(a.name)+'</span><span class="cat-count">'+n+"</span></button>"});var d=[];e.suggestions.forEach(function(e){e.categoryId&&e.categoryId.startsWith("doc:")&&-1===d.indexOf(e.categoryId)&&d.push(e.categoryId)}),d.length&&(s+='<div class="sidebar-section-label" style="margin-top:8px;"><i class="fa-solid fa-book" style="margin-right:4px;opacity:0.6;"></i>Doc Sections</div>',d.forEach(function(a){var n=o(a);if(n){var i=e.suggestions.filter(function(e){return e.categoryId===a&&e.status===t.currentView}).length;s+='<button class="cat-nav-item'+(t.currentCatFilter===a?" active":"")+'" onclick="filterCategory(\''+a+'\', this)" data-cat="'+a+'"><i class="fa-solid fa-file-lines" style="font-size:11px;color:var(--accent);flex-shrink:0;"></i><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">'+r(n.name)+'</span><span class="cat-count">'+i+"</span></button>"}})),a.innerHTML=s}}function L(){["pending","approved","rejected","archived"].forEach(function(t){var a=document.getElementById("count-"+t);a&&(a.textContent=e.suggestions.filter(function(e){return e.status===t}).length)});var t=document.getElementById("count-history");t&&(t.textContent=e.history.length)}function x(){try{var e=localStorage.getItem("accord-gh-config");e&&Object.assign(a,JSON.parse(e))}catch(e){}}function S(){localStorage.setItem("accord-gh-config",JSON.stringify(a))}function k(){var e=document.getElementById("dm-sync-dot"),t=document.getElementById("dm-sync-label");if(!a.pat||!a.repo)return e&&(e.className="dm-sync-dot"),void(t&&(t.textContent="Not configured ‚Äî click Configure"));e&&(e.className="dm-sync-dot connected");var n=[a.repo+" ¬∑ "+a.branch];a.path&&n.push("/"+a.path),a.lastPushAt&&n.push("pushed "+O(a.lastPushAt)),a.lastPullAt&&!a.lastPushAt&&n.push("pulled "+O(a.lastPullAt)),a.lastPushSha&&n.push(a.lastPushSha.slice(0,7)),t&&(t.textContent=n.join(" ¬∑ "))}function A(e){var t=document.getElementById("dm-sync-dot"),a=document.getElementById("gh-push-btn"),n=document.getElementById("gh-pull-btn");e?(t&&(t.className="dm-sync-dot busy"),a&&(a.disabled=!0),n&&(n.disabled=!0)):(k(),a&&(a.disabled=!1,a.innerHTML='<i class="fa-solid fa-upload"></i> Push'),n&&(n.disabled=!1,n.innerHTML='<i class="fa-solid fa-download"></i> Pull'))}function T(){var e=document.getElementById("dm-log"),t=document.getElementById("dm-log-inner");t&&(t.innerHTML=""),e&&(e.style.display="none")}function N(e,t){var a=document.getElementById("dm-log"),n=document.getElementById("dm-log-inner");a&&(a.style.display="block");var i=document.createElement("span");i.className="dm-log-line "+(t||""),i.textContent=e,n&&(n.appendChild(i),n.scrollTop=n.scrollHeight)}async function P(e,t,n){var i="https://api.github.com"+t,o={method:e,headers:{Authorization:"Bearer "+a.pat,Accept:"application/vnd.github+json","X-GitHub-Api-Version":"2022-11-28","Content-Type":"application/json"}};void 0!==n&&(o.body=JSON.stringify(n));var s=await fetch(i,o),c=await s.json().catch(function(){return{}});if(!s.ok)throw new Error((c.message||s.statusText||"HTTP "+s.status)+(c.errors?" ‚Äî "+JSON.stringify(c.errors):""));return c}async function H(e,t){return(await P("POST","/repos/"+a.repo+"/git/blobs",{content:e,encoding:t||"utf-8"})).sha}function O(e){if(!e)return"";var t=Math.floor((Date.now()-new Date(e).getTime())/1e3);return t<60?t+"s ago":t<3600?Math.floor(t/60)+"m ago":t<86400?Math.floor(t/3600)+"h ago":Math.floor(t/86400)+"d ago"}function M(e){return e.replace(/[^a-zA-Z0-9._\-]/g,"_").slice(0,80)}function D(e,t){return{jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",svg:"image/svg+xml",mp4:"video/mp4",webm:"video/webm",mov:"video/quicktime",avi:"video/x-msvideo"}[(e.split(".").pop()||"").toLowerCase()]||t}function F(){var e=document.querySelectorAll("#docs-nav-list .docs-nav-item"),t=document.getElementById("main").scrollTop,a=null;if(e.forEach(function(e){var n=e.getAttribute("data-doc-id"),i=document.getElementById(n);i&&i.offsetTop-80<=t&&(a=n),e.classList.remove("active")}),a){var n=document.querySelector('#docs-nav-list [data-doc-id="'+a+'"]');n&&n.classList.add("active")}}window.setView=(e,a)=>{t.currentView=e,document.querySelectorAll(".sidebar-btn").forEach(function(e){e.classList.remove("active")}),a.classList.add("active"),document.querySelectorAll(".page").forEach(function(e){e.classList.remove("active")}),document.getElementById("page-"+e).classList.add("active"),C(),"history"===e?B():y()},window.filterCategory=function(e,a){t.currentCatFilter=e,document.querySelectorAll(".cat-nav-item").forEach(function(e){e.classList.remove("active")}),a&&a.classList.add("active"),y()},window.switchPageTab=a=>{document.getElementById("tab-docs").classList.toggle("active","docs"===a),document.getElementById("tab-suggestions").classList.toggle("active","suggestions"===a);var n=document.getElementById("suggestions-sidebar-nav"),i=document.getElementById("docs-sidebar-nav"),o=document.getElementById("main");if("docs"===a)n.classList.add("hidden"),i.classList.add("visible"),["pending","approved","rejected","archived","history"].forEach(function(e){var t=document.getElementById("page-"+e);t&&t.classList.remove("active")}),document.getElementById("page-docs").classList.add("active"),function(){var t=document.getElementById("docs-content"),a=document.getElementById("docs-nav-list");if(!e.docs||!e.docs.length)return t.innerHTML='<div class="docs-empty-state"><div class="empty-icon"><i class="fa-solid fa-file-lines"></i></div><h3>No documentation loaded</h3><p>Import a JSON file containing a <code>docs</code> array to view the technical design document here.</p></div>',void(a.innerHTML="");var n=e.docs.map(function(e){var t=e.level>=3,a=e.title.replace(/\s+/g," ").trim();return a.length>36&&(a=a.slice(0,34)+"‚Ä¶"),'<a class="docs-nav-item'+(t?" sub":"")+'" href="#" onclick="scrollToDocSection(\''+e.id+'\');return false;" data-doc-id="'+e.id+'">'+r(a)+"</a>"}).join("");a.innerHTML=n;var i=e.docs.map(function(e){return'<div class="docs-section" id="doc-sec-'+e.id+'"><a class="docs-section-anchor" id="'+e.id+'"></a>'+e.contentHtml+"</div>"}).join("\n");t.innerHTML=i;var o=a.querySelector(".docs-nav-item");o&&o.classList.add("active")}(),b(document.getElementById("docs-content")),o.addEventListener("scroll",F,{passive:!0});else{n.classList.remove("hidden"),i.classList.remove("visible"),document.getElementById("page-docs").classList.remove("active"),o.removeEventListener("scroll",F);var s=t.currentView;["pending","approved","rejected","archived","history"].forEach(function(e){var t=document.getElementById("page-"+e);t&&t.classList.toggle("active",e===s)})}},window.openDataModal=function(){x(),document.getElementById("gh-pat").value=a.pat||"",document.getElementById("gh-repo").value=a.repo||"",document.getElementById("gh-branch").value=a.branch||"main",document.getElementById("gh-path").value=a.path||"";var t=document.getElementById("dm-gh-config");t&&(a.pat&&a.repo?t.classList.remove("open"):t.classList.add("open")),k(),T();var n=e.suggestions.reduce(function(e,t){return e+(t.attachments?t.attachments.length:0)},0),i=e.suggestions.reduce(function(e,t){return e+(t.attachments||[]).reduce(function(e,t){return e+(t.data?t.data.length:0)},0)},0),o=document.getElementById("data-stats");o&&(o.innerHTML='<div class="data-stat-chip"><strong>'+e.suggestions.length+'</strong> suggestions</div><div class="data-stat-chip"><strong>'+n+'</strong> attachments</div><div class="data-stat-chip"><strong>'+(i/1024/1024).toFixed(2)+' MB</strong> media</div><div class="data-stat-chip"><strong>'+e.history.length+"</strong> history entries</div>"),d("modal-data")},window.openSettings=function(){document.getElementById("settings-team").value=e.config.teamName,d("modal-settings")},window.toggleTheme=function(e){document.documentElement.setAttribute("data-theme",e.checked?"light":"dark"),localStorage.setItem("accord-theme",e.checked?"light":"dark")},window.openCategoryPicker=function(){t.editingId=null,t.selectedCatId=null,t.pendingAttachments=[];var e=document.getElementById("cat-search-input");e&&(e.value=""),j(""),d("modal-cat-picker")},window.renderPage=y,window.renderHistory=B,window.confirmAction=function(a,i){if(s(i)){document.getElementById("confirm-title").textContent=a.charAt(0).toUpperCase()+a.slice(1)+" Suggestion",document.getElementById("confirm-msg").textContent={approve:"Approve this suggestion and move it to documentation?",reject:"Reject this suggestion?",revoke:"Remove this approved suggestion from documentation? It will be moved to Rejected.",archive:"Archive this rejected suggestion? It will be hidden from the main rejected view.",restore:"Restore this suggestion back to Pending?"}[a]||"";var o=document.getElementById("confirm-note");o.value="",o.style.display=["reject","revoke"].includes(a)?"block":"none";var c=document.getElementById("confirm-ok-btn");c.className="btn "+({approve:"btn-primary",reject:"btn-danger",revoke:"btn-danger",archive:"btn-ghost",restore:"btn-accent"}[a]||"btn-primary"),c.textContent=a.charAt(0).toUpperCase()+a.slice(1),t.confirmCallback=function(){var t=document.getElementById("confirm-note").value.trim();!function(t,a,i){var o=s(a);if(o){var c=e.config.teamName,r=(new Date).toISOString();"approve"===t?(o.status="approved",o.approvedBy=c,o.updatedAt=r,f("approved",a,o.title,c,i),u("Suggestion approved! ‚úì","success")):"reject"===t?(o.status="rejected",o.rejectedBy=c,o.updatedAt=r,f("rejected",a,o.title,c,i),u("Suggestion rejected.","info")):"revoke"===t?(o.status="rejected",o.rejectedBy=c,o.updatedAt=r,f("revoked",a,o.title,c,i),u("Removed from documentation.","info")):"archive"===t?(o.status="archived",o.archivedBy=c,o.updatedAt=r,f("archived",a,o.title,c,i),u("Archived.","info")):"restore"===t&&(o.status="pending",o.updatedAt=r,f("restored",a,o.title,c,""),u("Restored to pending.","success")),n(),L(),y(),C()}}(a,i,t)},d("modal-confirm")}},window.openEditor=e=>openEditor(e),window.closeModal=l,window.filterCatOptions=function(e){j(e)},window.openNewCatModal=function(){var e=document.getElementById("new-cat-name");e&&(e.value=""),t.newCatEmojiSelected="üóÇÔ∏è";var a=document.getElementById("new-cat-emoji-preview");a&&(a.textContent="üóÇÔ∏è"),d("modal-new-cat")},window.selectCat=function(e,a){t.selectedCatId=e,document.querySelectorAll(".cat-option").forEach(function(e){e.classList.remove("selected")}),a.classList.add("selected")},window.proceedToEditor=function(){t.selectedCatId?(l("modal-cat-picker"),function(e){t.editingId=e;var a=o(t.selectedCatId);t.tagEmojiSelected="üè∑Ô∏è",t.pendingAttachments=[];var n=document.getElementById("editor-modal-title");n&&(n.textContent="New Suggestion");var i=document.getElementById("editor-modal-subtitle");i&&(i.textContent="Category: "+(a?a.emoji+" "+a.name:"‚Äî"));var s=document.getElementById("editor-tag");s&&(s.value="");var c=document.getElementById("editor-tag-emoji-display");c&&(c.textContent=t.tagEmojiSelected);var r=document.getElementById("editor-title");r&&(r.value="");var l=document.getElementById("editor-body");l&&(l.value="");var m=document.getElementById("editor-preview");m&&m.classList.remove("show"),l&&(l.style.display="block");var u=document.getElementById("preview-toggle-btn");u&&u.classList.remove("active"),p(null),h(),d("modal-editor")}(null)):u("Please select a category first.","error")},window.saveNewCategory=function(){var a=document.getElementById("new-cat-name"),i=a?a.value.trim():"";if(i){var o={id:"cat_"+Date.now(),name:i,emoji:t.newCatEmojiSelected};e.categories.push(o),n(),C(),l("modal-new-cat"),t.selectedCatId=o.id;var s=document.getElementById("cat-search-input");j(s?s.value:""),u('Category "'+i+'" created!',"success")}else u("Category name required.","error")},window.toggleEmojiPicker=function(e){var t=document.getElementById(e);t&&t.classList.toggle("show")},window.onTagInput=function(t){var a=document.getElementById("tag-suggestions-list");if(a)if(t.trim()){var n=t.toUpperCase(),i=e.tags.filter(function(e){return e.name.includes(n)});i.length?(a.innerHTML=i.map(function(e){return'<div class="tag-suggestion-item" onmousedown="selectTag(\''+r(e.name)+"','"+r(e.emoji||"üè∑Ô∏è")+"')\"><span>"+r(e.emoji||"üè∑Ô∏è")+'</span><span class="tag-sug-name">'+r(e.name)+"</span></div>"}).join(""),a.classList.add("show")):a.classList.remove("show")}else a.classList.remove("show")},window.hideSugAfterDelay=function(){setTimeout(function(){var e=document.getElementById("tag-suggestions-list");e&&e.classList.remove("show")},200)},window.tbInsert=function(e){var t=document.getElementById("editor-body");if(t){var a=t.selectionStart,n=t.selectionEnd,i=t.value.slice(a,n),o="";"link"===e?o="("+(i||"link text")+" [https://example.com])":"tooltip"===e?o="("+(i||"term")+" <Tooltip description here>)":"keyword"===e?o="(["+(i||"keyword")+"])":"bold"===e?o="**"+(i||"bold text")+"**":"code"===e&&(o="`"+(i||"code")+"`");var s=t.value;t.value=s.slice(0,a)+o+s.slice(n),t.focus(),t.selectionStart=t.selectionEnd=a+o.length}},window.triggerAttach=function(e){t.attachType=e;var a=document.getElementById("attach-drop-input");a&&(a.accept="image"===e?"image/*":"video/*",a.click())},window.openCodeInsert=function(e){t.codeInsertMode=e;var a=document.getElementById("code-insert-title");a&&(a.textContent="html"===e?"Insert HTML Block":"Insert Mermaid Diagram");var n=document.getElementById("code-insert-sub");n&&(n.textContent="html"===e?"Renders in an iframe sandbox":"Mermaid diagram syntax");var i=document.getElementById("code-insert-area");i&&(i.value="mermaid"===e?"graph TD\n    A[Start] --\x3e B[End]":"<h1>Hello World</h1>"),d("modal-code-insert")},window.togglePreview=function(){var e=document.getElementById("editor-body"),t=document.getElementById("editor-preview"),a=document.getElementById("preview-toggle-btn");if(e&&t&&a)if(t.classList.contains("show"))t.classList.remove("show"),e.style.display="block",a.classList.remove("active");else{t.innerHTML=w(e.value),t.classList.add("show"),e.style.display="none",a.classList.add("active");var n=t.querySelectorAll(".mermaid");n.length&&mermaid.run({nodes:Array.from(n)})}},window.onDropZoneDragOver=e=>{e.preventDefault(),document.getElementById("attach-drop-zone").classList.add("drag-over")},window.onDropZoneDragLeave=e=>{document.getElementById("attach-drop-zone").classList.remove("drag-over")},window.onDropZoneDrop=e=>{e.preventDefault(),document.getElementById("attach-drop-zone").classList.remove("drag-over"),v(e.dataTransfer.files)},window.handleDropZoneFiles=v,window.saveSuggestion=function(){var a=document.getElementById("editor-tag"),i=a?a.value.trim().toUpperCase():"",o=document.getElementById("editor-title"),c=o?o.value.trim():"",r=document.getElementById("editor-body"),d=r?r.value:"";if(c)if(i){var m=[0,1,2].map(function(e){return{label:(document.getElementById("ib-label-"+e)||{}).value||"",value:(document.getElementById("ib-val-"+e)||{}).value||""}}),g=e.tags.find(function(e){return e.name===i});g||e.tags.push({id:"tag_"+Date.now(),name:i,emoji:t.tagEmojiSelected});var p=(new Date).toISOString();if(t.editingId){var v=s(t.editingId);v&&(v.tag={name:i,emoji:g?g.emoji:t.tagEmojiSelected},v.categoryId=t.selectedCatId,v.title=c,v.body=d,v.infoBoxes=m,v.attachments=t.pendingAttachments,v.updatedAt=p,f("edited",v.id,c,e.config.teamName,""),u("Suggestion updated!","success"))}else{var h={id:"sug_"+Date.now(),categoryId:t.selectedCatId,tag:{name:i,emoji:g?g.emoji:t.tagEmojiSelected},title:c,body:d,infoBoxes:m,status:"pending",suggestedBy:e.config.teamName,approvedBy:null,rejectedBy:null,archivedBy:null,createdAt:p,updatedAt:p,attachments:t.pendingAttachments};e.suggestions.push(h),f("created",h.id,c,e.config.teamName,""),u("Suggestion created!","success")}n(),L(),y(),C(),l("modal-editor")}else u("Tag is required.","error");else u("Title is required.","error")},window.confirmCodeInsert=function(){var e=document.getElementById("code-insert-area"),a=e?e.value:"";a.trim()?(t.pendingAttachments.push({type:t.codeInsertMode,name:"mermaid"===t.codeInsertMode?"diagram":"html-block",data:a}),h(),l("modal-code-insert"),u(("mermaid"===t.codeInsertMode?"Mermaid diagram":"HTML block")+" attached!","success")):l("modal-code-insert")},window.saveSettings=function(){var t=document.getElementById("settings-team").value.trim()||"Anonymous";e.config.teamName=t,document.getElementById("topbar-team").textContent=t,n(),l("modal-settings"),u("Settings saved!","success")},window.togglePatVisibility=function(){var e=document.getElementById("gh-pat");e&&(e.type="password"===e.type?"text":"password")},window.ghTestConnection=async function(){a.pat=document.getElementById("gh-pat").value.trim(),a.repo=document.getElementById("gh-repo").value.trim().replace(/^https?:\/\/github\.com\//,"").replace(/\.git$/,""),a.branch=document.getElementById("gh-branch").value.trim()||"main";var e=document.getElementById("gh-test-btn"),t=document.getElementById("dm-gh-status");e.textContent="Testing‚Ä¶",e.disabled=!0,t.style.display="none";try{var n=await P("GET","/repos/"+a.repo);t.className="dm-gh-status ok",t.textContent="‚úì Connected to "+n.full_name+" ("+n.default_branch+" default) ¬∑ "+(n.private?"private":"public")+" repo",t.style.display="block",await P("GET","/repos/"+a.repo+"/git/ref/heads/"+a.branch),t.textContent+=' ¬∑ branch "'+a.branch+'" exists ‚úì'}catch(e){t.className="dm-gh-status err",t.textContent="‚úó "+e.message,t.style.display="block"}e.textContent="Test Connection",e.disabled=!1},window.ghSaveConfig=function(){a.pat=document.getElementById("gh-pat").value.trim(),a.repo=document.getElementById("gh-repo").value.trim().replace(/^https?:\/\/github\.com\//,"").replace(/\.git$/,""),a.branch=document.getElementById("gh-branch").value.trim()||"main",a.path=document.getElementById("gh-path").value.trim().replace(/^\/|\/$/g,""),S(),document.getElementById("dm-gh-config").classList.remove("open"),k(),u("GitHub config saved.","success")},window.ghPull=async function(){if(x(),!a.pat||!a.repo)return u("Configure GitHub first.","error"),void document.getElementById("dm-gh-config").classList.add("open");document.getElementById("gh-pull-btn").textContent="Pulling‚Ä¶",A(!0),T();try{var t=a.path?a.path+"/":"";N("Fetching accord-data.json‚Ä¶");var i=t+"accord-data.json",o=function(e){for(var t=atob(e),a=new Uint8Array(t.length),n=0;n<t.length;n++)a[n]=t.charCodeAt(n);return new TextDecoder("utf-8").decode(a)}((await P("GET","/repos/"+a.repo+"/contents/"+encodeURIComponent(i)+"?ref="+encodeURIComponent(a.branch))).content.replace(/\n/g,"")),s=JSON.parse(o);N("  JSON fetched ("+(o.length/1024).toFixed(1)+" KB)","ok");var c=[];(s.suggestions||[]).forEach(function(e){(e.attachments||[]).forEach(function(t,a){t.data&&t.data.startsWith("attachments/")&&c.push({s:e,a:t,ai:a})})}),N("Fetching "+c.length+" attachment"+(1!==c.length?"s":"")+"‚Ä¶");for(var r=0;r<c.length;r++){var d=c[r],l=d.a.data,m=t+l;N("  "+(r+1)+"/"+c.length+": "+l);try{var g=(await P("GET","/repos/"+a.repo+"/contents/"+encodeURIComponent(m)+"?ref="+encodeURIComponent(a.branch))).content.replace(/\n/g,""),f="image"===d.a.type?D(l,"image/png"):D(l,"video/mp4");d.a.data="data:"+f+";base64,"+g}catch(e){N("  ‚ö† Could not fetch "+l+": "+e.message,"warn")}}var p=e.config.teamName;e.config=s.config||e.config,e.categories=s.categories||[],e.tags=s.tags||[],e.suggestions=s.suggestions||[],e.history=s.history||[],e.docs=s.docs||[],e.config.teamName||(e.config.teamName=p),n(),L(),y(),C(),document.getElementById("topbar-team").textContent=e.config.teamName,document.getElementById("settings-team").value=e.config.teamName,a.lastPullAt=(new Date).toISOString(),S(),N("‚úì Pull complete ‚Äî "+e.suggestions.length+" suggestions loaded.","ok"),u("Pulled from GitHub ‚úì","success")}catch(e){N("‚úó Pull failed: "+e.message,"err"),u("Pull failed: "+e.message,"error"),console.error(e)}A(!1)},window.ghPush=async function(){if(x(),!a.pat||!a.repo)return u("Configure GitHub first.","error"),void document.getElementById("dm-gh-config").classList.add("open");document.getElementById("gh-push-btn").textContent="Pushing‚Ä¶",A(!0),T();try{var t=a.path?a.path+"/":"";N("Getting branch ref‚Ä¶");var n=(await P("GET","/repos/"+a.repo+"/git/ref/heads/"+a.branch)).object.sha;N("  Latest commit: "+n.slice(0,7),"ok");var i=(await P("GET","/repos/"+a.repo+"/git/commits/"+n)).tree.sha;N("Serialising data‚Ä¶");for(var o=JSON.parse(JSON.stringify(e)),s=[],c=0,r=o.suggestions.reduce(function(e,t){return e+(t.attachments||[]).filter(function(e){return"image"===e.type||"video"===e.type}).length},0),d=0;d<o.suggestions.length;d++)for(var l=o.suggestions[d],m=0;m<(l.attachments||[]).length;m++){var g=l.attachments[m];if(("image"===g.type||"video"===g.type)&&g.data&&g.data.startsWith("data:")){var f=g.data.match(/^data:([^;]+);base64,(.+)$/);if(f){c++;var p=f[1].split("/")[1]||"bin",v=l.id+"_"+m+"_"+M(g.name||"file."+p),h=t+"attachments/"+v;N("  Uploading attachment "+c+"/"+r+": "+v);var y=await H(f[2],"base64");s.push({path:h,mode:"100644",type:"blob",sha:y}),g.data="attachments/"+v}}}N("Creating JSON blob‚Ä¶");var b=JSON.stringify(o,null,2),w=await H(b,"utf-8");s.push({path:t+"accord-data.json",mode:"100644",type:"blob",sha:w}),N("Creating tree ("+s.length+" file"+(1!==s.length?"s":"")+")‚Ä¶");var E=await P("POST","/repos/"+a.repo+"/git/trees",{base_tree:i,tree:s}),I=new Date,B="Accord sync - "+I.toISOString().replace("T"," ").slice(0,19)+" UTC\n\n"+e.suggestions.length+" suggestions ¬∑ "+e.history.length+" history entries ¬∑ pushed by "+e.config.teamName;N("Creating commit‚Ä¶");var j=await P("POST","/repos/"+a.repo+"/git/commits",{message:B,tree:E.sha,parents:[n]});N("Updating branch ref‚Ä¶"),await P("PATCH","/repos/"+a.repo+"/git/refs/heads/"+a.branch,{sha:j.sha}),a.lastPushAt=I.toISOString(),a.lastPushSha=j.sha,S(),N("‚úì Pushed! Commit: "+j.sha.slice(0,7)+" ‚Üí "+a.repo+":"+a.branch,"ok"),u("Pushed to GitHub ‚úì","success")}catch(e){N("‚úó Push failed: "+e.message,"err"),u("Push failed: "+e.message,"error"),console.error(e)}A(!1)},window.exportZip=async function(){var t=document.getElementById("export-zip-btn");t&&(t.textContent="Building‚Ä¶",t.disabled=!0);try{var a=new JSZip,n=a.folder("attachments"),i=JSON.parse(JSON.stringify(e));i.suggestions.forEach(function(e){(e.attachments||[]).forEach(function(t,a){if(("image"===t.type||"video"===t.type)&&t.data&&t.data.startsWith("data:")){var i=t.data.match(/^data:([^;]+);base64,(.+)$/);if(i){var o=i[1].split("/")[1]||"bin",s=e.id+"_"+a+"_"+M(t.name||"file."+o);n.file(s,i[2],{base64:!0}),t.data="attachments/"+s}}})}),a.file("accord-data.json",JSON.stringify(i,null,2));var o=await a.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:6}}),s=URL.createObjectURL(o),c=document.createElement("a");c.href=s,c.download="accord-data.zip",c.click(),URL.revokeObjectURL(s),u("accord-data.zip exported!","success")}catch(e){u("Export failed: "+e.message,"error")}t&&(t.innerHTML='<i class="fa-solid fa-download"></i> Export ZIP',t.disabled=!1)},window.importZip=async function(t){var a=t.files[0];if(a){t.value="";try{var i=await JSZip.loadAsync(a),o=i.file("accord-data.json");if(!o)throw new Error("accord-data.json not found in ZIP.");var s=await o.async("text"),c=JSON.parse(s),r={},d=i.folder("attachments");d&&d.forEach(function(e,t){r[e]=t});for(var m=0;m<(c.suggestions||[]).length;m++)for(var g=0;g<(c.suggestions[m].attachments||[]).length;g++){var f=c.suggestions[m].attachments[g];if(f.data&&f.data.startsWith("attachments/")){var p=f.data.slice(12);if(r[p]){var v=await r[p].async("base64");f.data="data:"+("image"===f.type?D(p,"image/png"):D(p,"video/mp4"))+";base64,"+v}}}e.config=c.config||e.config,e.categories=c.categories||[],e.tags=c.tags||[],e.suggestions=c.suggestions||[],e.history=c.history||[],e.docs=c.docs||[],n(),L(),y(),C(),document.getElementById("topbar-team").textContent=e.config.teamName,document.getElementById("settings-team").value=e.config.teamName,l("modal-data"),u("Data imported from ZIP!","success")}catch(e){u("Import failed: "+e.message,"error"),console.error(e)}}},window.openPasteJson=function(){document.getElementById("paste-json-input").value="",document.getElementById("paste-json-error").style.display="none",l("modal-data"),d("modal-paste-json"),setTimeout(function(){document.getElementById("paste-json-input").focus()},120)},window.pickSaveFolder=async function(){if(window.showDirectoryPicker)try{t.dirHandle=await window.showDirectoryPicker({mode:"readwrite"}),t.fileHandle=await t.dirHandle.getFileHandle("accord-data.json",{create:!0}),await i();var a=document.getElementById("folder-path-display");a&&(a.style.display="block",a.innerHTML='<i class="fa-solid fa-folder-open"></i> '+t.dirHandle.name+"/accord-data.json"),e.config.savedFolder=t.dirHandle.name,n(),u("Live sync active: "+t.dirHandle.name,"success")}catch(e){"AbortError"!==e.name&&u("Error: "+e.message,"error")}else u("File System Access API not supported.","error")},window.loadPastedJson=function(){var t=document.getElementById("paste-json-input").value.trim(),a=document.getElementById("paste-json-error");if(a.style.display="none",!t)return a.textContent="Nothing to load.",void(a.style.display="block");try{var i=JSON.parse(t),o=e.config.teamName;e.config=i.config||e.config,e.categories=i.categories||[],e.tags=i.tags||[],e.suggestions=i.suggestions||[],e.history=i.history||[],e.docs=i.docs||[],e.config.teamName||(e.config.teamName=o),n(),L(),y(),C(),document.getElementById("topbar-team").textContent=e.config.teamName,document.getElementById("settings-team").value=e.config.teamName,l("modal-paste-json"),u("JSON loaded ‚Äî "+e.suggestions.length+" suggestions, "+(e.docs||[]).length+" doc sections.","success")}catch(e){a.textContent="Parse error: "+e.message,a.style.display="block"}},window.executeConfirmAction=function(){t.confirmCallback&&t.confirmCallback(),l("modal-confirm")},window.removeAttachment=function(e){t.pendingAttachments.splice(e,1),h()},window.scrollToDocSection=function(e){var t=document.getElementById(e);t&&document.getElementById("main").scrollTo({top:t.offsetTop-60,behavior:"smooth"})},document.addEventListener("DOMContentLoaded",function(){!function(){var t=localStorage.getItem("accord-sg-data");if(t)try{var a=JSON.parse(t);e.config=a.config||{teamName:"Anonymous"},e.categories=a.categories||[],e.tags=a.tags||[],e.suggestions=(a.suggestions||[]).filter(function(e){return"sug_demo1"!==e.id&&"sug_demo2"!==e.id}),e.history=(a.history||[]).filter(function(e){return"sug_demo1"!==e.suggestionId&&"sug_demo2"!==e.suggestionId}),e.docs=a.docs||[];var n=new Set(e.suggestions.map(function(e){return e.categoryId})),i=new Set(["cat_net","cat_sec","cat_ui"]);e.categories=e.categories.filter(function(e){return!i.has(e.id)||n.has(e.id)}),e.tags=e.tags.filter(function(e){return"tag_net"!==e.id&&"tag_nat"!==e.id&&"tag_sec"!==e.id})}catch(e){}}(),x(),["emoji-grid-cat","emoji-grid-tag"].forEach(function(e){var t=document.getElementById(e);t&&(t.innerHTML=g.map(function(t){return"<button onmousedown=\"selectEmoji('"+e+"','"+t+'\')" title="'+t+'">'+t+"</button>"}).join(""))}),p(),L(),y(),C(),document.getElementById("topbar-team").textContent=e.config.teamName,document.getElementById("settings-team").value=e.config.teamName,document.addEventListener("click",function(e){if(!e.target.closest("#tag-emoji-picker")&&!e.target.closest("#editor-tag-emoji-btn")){var t=document.getElementById("tag-emoji-picker");t&&t.classList.remove("show")}if(!e.target.closest("#new-cat-emoji-picker")&&!e.target.closest("#new-cat-emoji-preview")){var a=document.getElementById("new-cat-emoji-picker");a&&a.classList.remove("show")}}),mermaid.initialize({startOnLoad:!1,theme:"default"})})})();